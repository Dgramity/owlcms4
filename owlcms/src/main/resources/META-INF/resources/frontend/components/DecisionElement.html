<link href="../bower_components/polymer/polymer-element.html"
	rel="import">

<dom-module id="decision-element">
<template>
<style>
.decisionWrapper {
	width: 100%;
	height: 100%;
}
.decisions {
	display: none;
	height: 100%;
	width: 100%;
	display: flex;
	align-items: stretch;
	justify-content: space-between;
}
.decision {
	border-radius: 5%;
	border: medium solid white;
	margin: 3%;
/* 	background-color: #333333; */
	width: 30%;
}
.red {
	background-color: red;
}

.white {
	background-color: white;
}

.none {
	background-color: #333333;
}

.down {
	display: flex;
	height: 100%;
    align-items: stretch;
	justify-content: space-evenly;
	--iron-icon-height: 100%;
    --iron-icon-width: 100%;
	font-weight: normal;
	color: lime;
	display:block;
}
</style>
<div class="decisionWrapper">
<div class="down" id="downDiv">
	<iron-icon id="down-arrow" icon="icons:file-download" on-click="showDecisions"></iron-icon>
</div>
<div class="decisions" id="decisionsDiv" on-click="hide">
	<span class="decision" id="ref1span" />&nbsp;</span>
	<span class="decision" id="ref2span" />&nbsp;</span>
	<span class="decision" id="ref3span" />&nbsp;</span>
</div>
</div>
</template>

<script>
  class DecisionElement extends Polymer.Element {

      static get is() {
          return 'decision-element'
      }

      static get properties() {
    	  return {
	           ref1: {
					type: Boolean,
					reflectToAttribute: true,
					notify: true,
					value: null
	           },
	           ref2: {
	               type: Boolean,
	               reflectToAttribute: true,
	               notify: true,
	               value: null
	           }, 
	           ref3: {
	               type: Boolean,
	               reflectToAttribute: true,
	               notify: true,
	               value: null
	           },
	           decision: {
					type: Boolean,
					notify: true
	           },
	           publicFacing: {
					type: Boolean,
					notify: true,
					reflectToAttribute: true,
					value: true
	           }
    	  }
      }
      
      ready() {
		super.ready();
		document.body.addEventListener('keydown', e => this._readRef(e));
		this._init();
      }
      
      _init() {
			this.$.decisionsDiv.style.display = "none";
			this.$.downDiv.style.display = "none";

			this.$.ref1span.className = "decision none";
			this.$.ref2span.className = "decision none";
			this.$.ref3span.className = "decision none";
			this.set('ref1',null);
			this.set('ref2',null);
			this.set('ref3',null);
			this._setupAudio();
      }
      
      _setupAudio() {
			// setup audio -- an oscillator cannot be reused.
			this.context = new AudioContext;
			this.oscillator = this.context.createOscillator();
			this.gain = this.context.createGain();
			this.gain.gain.value = 1;
			this.oscillator.frequency.value = 1000;  // maximum perceived loudness
			this.oscillator.connect(this.gain);
			this.gain.connect(this.context.destination);
      }
      
      _readRef(e) {
			var key = e.key;
			console.warn(key);
			switch (e.key) {
			case '1':
				this.set('ref1',true);
				this._majority(this.ref1,this.ref2,this.ref3)
				break;
			case '2':
				this.set('ref1',false);
				this._majority(this.ref1,this.ref2,this.ref3)
				break;
			case '3':
				this.set('ref2',true);
				this._majority(this.ref1,this.ref2,this.ref3)
				break;
			case '4':
				this.set('ref2',false);
				this._majority(this.ref1,this.ref2,this.ref3)
				break;
			case '5':
				this.set('ref3',true);
				this._majority(this.ref1,this.ref2,this.ref3)
				break;
			case '6':
				this.set('ref3',false);
				this._majority(this.ref1,this.ref2,this.ref3)
				break;
			default:
				break;
			}
		}
      
      _registerVote(code) {
    	  console.warn(key);
      }
      
      _majority(ref1,ref2,ref3) {
    	  var countWhite = 0;
    	  var countRed = 0;
    	  if (ref1 === true) {countWhite++;} else if (ref1 === false){countRed++;}
    	  if (ref2 === true) {countWhite++;} else if (ref2 === false){countRed++;}
    	  if (ref3 === true) {countWhite++;} else if (ref3 === false){countRed++;}
          var count = countWhite + countRed;
    	  if (count == 2 && (countWhite == 2 || countRed == 2)) {
    		  this.decision = (countWhite >= 2);
    		  this.showDown(true);
    	  }
    	  if ((countWhite + countRed) >= 3) {
    		  this.decision = (countWhite >= 2);
    		  // true means we are master -- we are telling the server that the decision has
    		  // been reached
    		  console.warn("full decision reached, setting timer before decisions are shown");
    		  
    		  // show the decisions after 3 seconds (by rule)
    		  setTimeout(this.showDecisions.bind(this, true, ref1, ref2, ref3), 3000);
    		  return (countWhite >= 2);
    	  } else {
    		  return undefined;
    	  }
      }
      
      setColors(parent, ref1, ref2, ref3) {  
    	  var redStyle = "decision red";
    	  var whiteStyle = "decision white";
    	  if (this.publicFacing) {
	    	  if (ref1 === true) {
	    		  parent.$.ref1span.className = whiteStyle;
	    	  } else if (ref1 === false){
	    		  parent.$.ref1span.className = redStyle;
	    	  }
	    	  if (ref2 === true) {
	    		  parent.$.ref2span.className = whiteStyle;
	    	  } else if (ref2 === false){
	    		  parent.$.ref2span.className = redStyle;
	    	  }
	    	  if (ref3 === true) {
	    		  parent.$.ref3span.className = whiteStyle;
	    	  } else if (ref3 === false){
	    		  parent.$.ref3span.className = redStyle;
	    	  }
    	  } else {
    		  // athlete facing, go the other way, right to left
	    	  if (ref1 === true) {
	    		  parent.$.ref3span.className = whiteStyle;
	    	  } else if (ref1 === false){
	    		  parent.$.ref3span.className = redStyle;
	    	  }
	    	  if (ref2 === true) {
	    		  parent.$.ref2span.className = whiteStyle;
	    	  } else if (ref2 === false){
	    		  parent.$.ref2span.className = redStyle;
	    	  }
	    	  if (ref3 === true) {
	    		  parent.$.ref1span.className = whiteStyle;
	    	  } else if (ref3 === false){
	    		  parent.$.ref1span.className = redStyle;
	    	  }
    	  }
      }
      
      showDown(isMaster) {
    	  console.warn("showDown");
    	  this.$.downDiv.style.display = "flex";
    	  this.oscillator.start(0);
    	  this.oscillator.stop(this.context.currentTime + 2);
    	  this._setupAudio();
    	  //this.$.downAudio.play();
		  this.dispatchEvent(new CustomEvent('down', {bubbles: true, composed: true}))
		  // if we are the master, tell the server
		  if (isMaster) {
			  this.$server.masterShowDown(this.decision, this.ref1, this.ref2, this.ref3);
		  }
		  // hide the down arrow after 2 seconds -- the decisions will show when available
		  // (there will be no decision lights for at least one second, more if last referee 
		  // waits after the other two have given down.
		  setTimeout(this.hideDown.bind(this), 2000);
      }
      
      hideDown() {
    	  this.$.downDiv.style.display = "none";
    	  this.$.decisionsDiv.style.display = "flex";
      }
      
      showDecisions(isMaster, ref1, ref2, ref3) {
    	  this.hideDown();
    	  console.warn("showDecision: "+ref1+" "+ref2+" "+ref3);
		  this.setColors(this, ref1, ref2, ref3);
		  console.warn("colorsShown");
    	  // hide the decisions after 5 seconds (this is arbitrary)
		  setTimeout(this.reset.bind(this, isMaster), 5000);
    	  // if we are the master, tell the server
    	  if (isMaster) {
    	  	this.$server.masterShowDecisions(this.decision, this.ref1, this.ref2, this.ref3);
    	  }
      }
      
      reset(isMaster) {
    	  this.hideDecisions();
    	  this._init();

    	  // if we are the master, tell the server
    	  if (isMaster) {
    	  	this.$server.masterReset();
    	  }
      }
      
      hideDecisions() {
    	  this.dispatchEvent(new CustomEvent('hide', {bubbles: true, composed: true}))
      }
  }
  
  customElements.define(DecisionElement.is, DecisionElement);
  </script> </dom-module>